# PostgreSQL HA Credentials Guide

This document explains all credentials used in the PostgreSQL HA cluster, how they're generated, and where they're used.

## Credential Overview

| Credential | Purpose | Generated By | Shared Across |
|------------|---------|--------------|---------------|
| `POSTGRES_PASSWORD` | Superuser authentication | Local openssl | All PG nodes, Pgpool |
| `PATRONI_REPLICATION_PASSWORD` | Streaming replication | Local openssl | All PG nodes, Pgpool |
| `PGPOOL_ADMIN_PASSWORD` | Pgpool control (PCP) | Manual | Pgpool only |

## How Credentials Are Generated

### Local Generation (set-shared-variables.sh)

Credentials are generated **on your local machine** and uploaded to Railway:

```bash
# Generate a 25-character alphanumeric password
openssl rand -base64 32 | tr -d "=+/" | cut -c1-25
```

**Step-by-step breakdown:**
1. `openssl rand -base64 32` - Generate 32 random bytes, encode as base64
2. `tr -d "=+/"` - Remove special characters that could cause issues in URLs/configs
3. `cut -c1-25` - Take first 25 characters for a clean password

**Example:**
```
openssl rand -base64 32  →  "K7xY2p+Qm3n/R8sT9u0V1w2X3y4Z5="
tr -d "=+/"              →  "K7xY2pQm3nR8sT9u0V1w2X3y4Z5"
cut -c1-25               →  "K7xY2pQm3nR8sT9u0V1w2X"
```

### Upload to Railway

After generation, credentials are uploaded to Railway's shared variables:

```bash
railway variables --set POSTGRES_PASSWORD="$POSTGRES_PASSWORD"
railway variables --set PATRONI_REPLICATION_PASSWORD="$REPLICATION_PASSWORD"
```

Railway stores these encrypted and injects them as environment variables at container runtime.

## Credential Flow Diagram

```
┌──────────────────────────────────────────────────────────────────┐
│                     LOCAL MACHINE                                 │
│                                                                   │
│  scripts/set-shared-variables.sh                                 │
│  ├── openssl rand → POSTGRES_PASSWORD                            │
│  ├── openssl rand → PATRONI_REPLICATION_PASSWORD                 │
│  └── railway variables --set (uploads to Railway)                │
└──────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                 RAILWAY SHARED VARIABLES                          │
│                                                                   │
│  POSTGRES_USER=railway                                           │
│  POSTGRES_PASSWORD=<generated>                                   │
│  POSTGRES_DB=railway                                             │
│  PATRONI_REPLICATION_USERNAME=replicator                         │
│  PATRONI_REPLICATION_PASSWORD=<generated>                        │
│  PATRONI_SCOPE=pg-ha-cluster                                     │
└──────────────────────────────────────────────────────────────────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         ▼                     ▼                     ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   postgres-1    │  │   postgres-2    │  │   postgres-3    │
│                 │  │                 │  │                 │
│ Receives:       │  │ Receives:       │  │ Receives:       │
│ - POSTGRES_*    │  │ - POSTGRES_*    │  │ - POSTGRES_*    │
│ - PATRONI_*     │  │ - PATRONI_*     │  │ - PATRONI_*     │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               ▼
                    ┌─────────────────────┐
                    │       Pgpool        │
                    │                     │
                    │ Receives:           │
                    │ - POSTGRES_PASSWORD │
                    │ - REPLICATION_PASS  │
                    │ - PGPOOL_ADMIN_*    │
                    └─────────────────────┘
```

## Detailed Credential Descriptions

### 1. Superuser Credentials

**Variables:**
- `POSTGRES_USER` (default: `railway`)
- `POSTGRES_PASSWORD` (required, generated)
- `POSTGRES_DB` (default: `railway`)

**Purpose:** Primary database access for applications and administration.

**Used by:**
- Application connections to the database
- Pgpool health checks (`health_check_user`)
- Pgpool recovery operations (`recovery_user`)
- Patroni superuser authentication

**Created in:** `patroni-runner.sh` via `bootstrap.users` section

### 2. Replication Credentials

**Variables:**
- `PATRONI_REPLICATION_USERNAME` (default: `replicator`)
- `PATRONI_REPLICATION_PASSWORD` (required, generated)

**Purpose:** PostgreSQL streaming replication between primary and replicas.

**Used by:**
- Patroni for replication authentication
- Replica nodes connecting to primary
- Pgpool streaming replication checks (`sr_check_user`)

**Created in:**
- Primary: `patroni-runner.sh` → `bootstrap.users` section (during initdb)
- Safety net: `post_bootstrap.sh` ensures user exists

### 3. Pgpool Admin Credentials

**Variables:**
- `PGPOOL_ADMIN_USERNAME` (default: `admin`)
- `PGPOOL_ADMIN_PASSWORD` (required, manual)

**Purpose:** Pgpool Control Protocol (PCP) administration commands.

**Used by:**
- `pcp_*` commands for pool management
- `patroni-watcher.py` for backend management
- Health monitoring scripts

**Created in:** `pgpool/run.sh` generates `pcp.conf` with MD5 hash

## PostgreSQL Users Summary

| User | Role | Created By | Authentication |
|------|------|------------|----------------|
| `postgres` | Superuser | PostgreSQL initdb | Password (md5) |
| `railway` | Superuser (custom) | bootstrap.users | Password (md5) |
| `replicator` | Replication only | bootstrap.users | Password (md5) |

## File Locations

### Where credentials are defined:
- `scripts/set-shared-variables.sh` - Generation and upload
- `scripts/deploy-postgres-*.sh` - Railway variable references

### Where credentials are consumed:
- `postgres-patroni/patroni-runner.sh` - Patroni YAML generation
- `postgres-patroni/post_bootstrap.sh` - User creation safety net
- `pgpool/run.sh` - PCP configuration
- `pgpool/pgpool.conf` - Connection settings

## Security Considerations

### What's secure:
- Passwords generated with cryptographic randomness (openssl)
- Stored encrypted in Railway's variable system
- SSL/TLS enabled for all connections
- MD5 authentication for remote connections

### Recommendations:
1. Never commit generated passwords to git
2. Use `${{shared.VARIABLE}}` syntax in Railway configs
3. Rotate credentials periodically by re-running `set-shared-variables.sh`
4. Store initial passwords securely (shown once during setup)

## Troubleshooting

### "authentication failed for user replicator"
The replicator user password may be out of sync. Check:
1. `PATRONI_REPLICATION_PASSWORD` is set in Railway shared variables
2. All postgres nodes have the same value
3. Restart the primary node to re-run bootstrap

### "password authentication failed for user postgres"
1. Verify `POSTGRES_PASSWORD` is set correctly
2. Check the password doesn't contain special characters that need escaping
3. Ensure Pgpool has the same password configured

### Verifying credentials
```bash
# On any postgres node
psql -U railway -d railway -c "SELECT 1"

# Check replication user
psql -U postgres -c "SELECT rolname, rolreplication FROM pg_roles WHERE rolname = 'replicator'"
```
