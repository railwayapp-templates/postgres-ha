global
    maxconn 1000
    log stdout format raw local0

defaults
    log global
    mode tcp
    retries 3
    timeout connect 10s
    timeout client 30m
    timeout server 30m
    timeout check 5s

resolvers railway
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    hold obsolete   10s

# Stats page for monitoring
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s

# Primary PostgreSQL (read-write)
# Routes to the current Patroni leader
frontend postgresql_primary
    bind *:5432
    default_backend postgresql_primary_backend

backend postgresql_primary_backend
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions resolvers railway init-addr none
    server postgres-1 postgres-1.railway.internal:5432 check port 8008
    server postgres-2 postgres-2.railway.internal:5432 check port 8008
    server postgres-3 postgres-3.railway.internal:5432 check port 8008

# Replica PostgreSQL (read-only)
# Routes to healthy replicas for read scaling
frontend postgresql_replicas
    bind *:5433
    default_backend postgresql_replicas_backend

backend postgresql_replicas_backend
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions resolvers railway init-addr none
    server postgres-1 postgres-1.railway.internal:5432 check port 8008
    server postgres-2 postgres-2.railway.internal:5432 check port 8008
    server postgres-3 postgres-3.railway.internal:5432 check port 8008
